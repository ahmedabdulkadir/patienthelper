<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Home - Brand</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Cabin:700">
    <link rel="stylesheet" href="assets/fonts/font-awesome.min.css">
</head>

<body id="page-top">
    <!-- <header class="masthead" style="background-image:url('assets/img/intro-bg.jpg');">
        <div class="intro-body">
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <h1 class="brand-heading">You are done!</h1>
                        <p class="intro-text">Please refresh this page if you would like prescribe another medication.</p></div>
                </div>
            </div>
        </div>
    </header> -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
    <script src="controllers/patient_information_controller.js"></script>
    <script src="assets/js/grayscale.js"></script>
    <script src="https://embed.typeform.com/embed.js" type="text/javascript"></script>
    <script type="text/javascript">
        var last_result;

        // function to process the request
        function ProcessRequest() {
            if ( xmlHttp.readyState == 4 && xmlHttp.status == 200 ) 
            {
                if ( xmlHttp.responseText == "Not found" ) 
                {
                    console.log("nothing found");
                    // document.getElementById( "TextBoxCustomerName"    ).value = "Not found";
                    // document.getElementById( "TextBoxCustomerAddress" ).value = "";
                }
                else
                {

                    var results = JSON.parse(xmlHttp.responseText);
                    last_result = results.items[0];
                    // console.log("someting found");

                    // console.log(results);
                    // console.log("item");

                    // console.log(results.items);
                    console.log(last_result);

                    var pid = last_result.answers[0].text;
                    var prescription = last_result.answers[1].text;

                    console.log(pid);
                    console.log(prescription);

                    var prescription_low = prescription.toLowerCase();
                    console.log(prescription_low);
                    if (prescription_low.includes("valium")){
                        if (confirm("You are prescribing 'Valium' to a person who is aged 67 years old, which goes against Beers criteria! Would you like to proceed?")) {
                            SendPOSTRequest(prescription, true);
                            alert("Presciption submitted! Feel free to exit the browser or go back.");
                        } else {
                            alert("Pleae refresh this page to re-write the prescription form.");
                        }
                    } else {
                        SendPOSTRequest(prescription, false);
                        alert("Presciption submitted! Feel free to exit the browser or go back.");
                    }
                    // var info = eval ( "(" + xmlHttp.responseText + ")" );

                    // // No parsing necessary with JSON!        
                    // document.getElementById( "TextBoxCustomerName"    ).value = info.jsonData[ 0 ].cmname;
                    // document.getElementById( "TextBoxCustomerAddress" ).value = info.jsonData[ 0 ].cmaddr1;
                }                    
            }
        }
        function SendPOSTRequest(prescription, beers_contradicting){
            var xhr = new XMLHttpRequest();
            xhr.open("POST", '/prescription', true);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xhr.onreadystatechange = function() { // Call a function when the state changes.
                if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                    // Request finished. Do processing here.
                    console.log("successfully submitted");
                }
            }

            const submission = {
                            'prescription': prescription,
                            'date': new Date(),
                            'beers_flag': beers_contradicting
                };

            xhr.send(JSON.stringify(submission));
            // xhr.send(new Int8Array()); 
            // xhr.send(document);
        }
        function SendGETRequest(){
            const queryURL = "https://api.typeform.com/forms/m49XRy/responses"; // type form id
            xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = ProcessRequest;
            xmlHttp.open( "GET", queryURL, true );
            xmlHttp.setRequestHeader('authorization', 'bearer 7tvmShvJGC7ZtrZRo2GFprLz7Z84Ay8q7as1ypkQYEEv');
            xmlHttp.send( null );
        }

        window.addEventListener('DOMContentLoaded', function () {
            // When instantiating a popup embed, you must provide the URL
            // of your typeform and your desired embed settings. If you don't
            // provide any settings, a default 'popup' embed is instantiated.
            // If you use 'autoOpen', your embedded typeform will open right
            // away when the page loads.

            window.typeformEmbed.makePopup('https://charlieyang.typeform.com/to/m49XRy', { // change this to our typeform
            autoOpen: true,
            onSubmit: function () {
                console.log('Typeform successfully submitted')

                // var date = new Date(Date.now() - 1000 * 10); // get current time and subtract 10 seconds
                // const dateString = date.toISOString();
                // console.log(dateString);
                // const queryURL = "https://api.typeform.com/forms/m49XRy/responses?since=" + dateString; // type form id

                // wait 5 seconds
                setTimeout(SendGETRequest, 3000);
            }
            });
        });
    </script>
</body>

</html>